<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Lectures</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#f4f6f9]">

  <%- include('../partials/header.ejs') %>

  <div class="flex">
    <%- include('../partials/sidebar.ejs') %>

    <main class="flex-1 p-6">

      <!-- HEADER -->
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-2xl font-bold">Manage Lectures</h2>
          <p class="text-sm text-gray-500">
            Course: <span class="font-semibold"><%= course.title %></span>
          </p>
        </div>

        <button
          class="px-5 py-2 bg-blue-600 text-white rounded-lg"
          onclick="showAddLectureForm()">
          + Add Lecture
        </button>
      </div>

      <!-- ADD LECTURE FORM -->
      <div
        id="addLectureForm"
        class="bg-white rounded-xl shadow-sm p-6 hidden">

        <h3 class="text-lg font-bold mb-4">Add New Lecture</h3>

        <form
            method="POST"
            action="/api/course-content/add-lecture"
            enctype="multipart/form-data"
            class="space-y-4"
        >

        <input type="hidden" name="course" value="<%= course._id %>">

          <!-- Section -->
          <div>
            <label class="block text-sm font-medium mb-1">Section Title *</label>
            <input type="text" name="sectionTitle"
              class="w-full px-4 py-2 border rounded-lg"
              placeholder="Basics of C">
          </div>

          <!-- Topic -->
          <div>
            <label class="block text-sm font-medium mb-1">Topic *</label>
            <input type="text" name="topic"
              class="w-full px-4 py-2 border rounded-lg"
              placeholder="Variables">
          </div>

          <!-- Sub Topic -->
          <div>
            <label class="block text-sm font-medium mb-1">Sub Topic</label>
            <input type="text" name="subTopic"
              class="w-full px-4 py-2 border rounded-lg"
              placeholder="Data types">
          </div>

          <!-- Lecture Title -->
          <div>
            <label class="block text-sm font-medium mb-1">Lecture Title *</label>
            <input type="text" name="lectureTitle"
              class="w-full px-4 py-2 border rounded-lg"
              placeholder="Introduction to Variables">
          </div>

          <!-- Lecture Type -->
          <div>
            <label class="block text-sm font-medium mb-1">Lecture Type *</label>
            <select
              name="lectureType"
              class="w-full px-4 py-2 border rounded-lg bg-white"
              onchange="toggleLectureType(this.value)">
              <option value="">Select</option>
              <option value="video">Recorded Video</option>
              <option value="live">Live Class</option>
            </select>
          </div>

          <!-- Video URL -->
          <div id="videoField" class="hidden">
                <label class="block text-sm font-medium mb-1">Upload Video</label>
                <input
                    type="file"
                    name="video"
                    accept="video/*"
                    class="w-full px-4 py-2 border rounded-lg"
                />
            </div>


          <!-- Live Class -->
         <!-- Live Class Fields -->
        <div id="liveField" class="hidden space-y-3">

        <div>
            <label class="block text-sm font-medium mb-1">Meeting Link *</label>
            <input
            type="text"
            name="liveClass[meetingLink]"
            class="w-full px-4 py-2 border rounded-lg"
            placeholder="https://meet.google.com/xxx"
            />
        </div>

        <div>
            <label class="block text-sm font-medium mb-1">Scheduled Date & Time *</label>
            <input
            type="datetime-local"
            name="liveClass[scheduledAt]"
            class="w-full px-4 py-2 border rounded-lg"
            />
        </div>

        <div>
            <label class="block text-sm font-medium mb-1">Duration</label>
            <input
            type="text"
            name="liveClass[duration]"
            class="w-full px-4 py-2 border rounded-lg"
            placeholder="1 hour"
            />
        </div>

        </div>

          <!-- Preview -->
          <div class="flex items-center gap-2">
            <input type="checkbox" name="isPreview">
            <label class="text-sm">Free Preview</label>
          </div>

          <!-- Actions -->
          <div class="flex gap-3 pt-4 border-t">
            <button type="button"
              onclick="hideAddLectureForm()"
              class="px-6 py-2 border rounded-lg">
              Cancel
            </button>

            <button type="submit"
              class="px-6 py-2 bg-green-600 text-white rounded-lg">
              Save Lecture
            </button>
          </div>

        </form>
      </div>
      <!-- ================= LECTURE LIST ================= -->
    <div class="mt-8 bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b">
        <h3 class="text-lg font-bold">Lectures</h3>
    </div>

    <table class="w-full">
        <thead class="bg-gray-50">
        <tr>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500">Section</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500">Lecture</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500">Type</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500">Status</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500">Actions</th>
        </tr>
        </thead>

        <tbody>
        <% lectures.forEach(l => { %>
            <tr class="border-t hover:bg-gray-50">
            <td class="px-6 py-4 text-sm"><%= l.sectionTitle %></td>

            <td class="px-6 py-4 text-sm">
                <div class="font-semibold"><%= l.lectureTitle %></div>
                <div class="text-xs text-gray-500"><%= l.topic %></div>
            </td>

            <td class="px-6 py-4 text-sm capitalize">
                <%= l.lectureType %>
            </td>

            <td class="px-6 py-4 text-sm">
                <span class="px-3 py-1 rounded-full text-xs font-semibold
                <%= l.isPublished ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' %>">
                <%= l.isPublished ? 'Published' : 'Draft' %>
                </span>
            </td>

            <td class="px-6 py-4 text-sm">
                <% if (!l.isPublished) { %>
                <button
                    class="px-3 py-1 bg-green-600 text-white rounded text-xs"
                    onclick="publishLecture('<%= l._id %>')">
                    Publish
                </button>
                <% } else { %>
                <button
                    class="px-3 py-1 bg-gray-600 text-white rounded text-xs"
                    onclick="unpublishLecture('<%= l._id %>')">
                    Unpublish
                </button>
                <% } %>
            </td>
            </tr>
        <% }) %>
        </tbody>
    </table>
    </div>
    </main>
  </div>

  <script>
    function showAddLectureForm() {
      document.getElementById('addLectureForm').classList.remove('hidden');
    }

    function hideAddLectureForm() {
      document.getElementById('addLectureForm').classList.add('hidden');
    }
     async function publishLecture(id) {
    try {
      const res = await fetch(`/api/course-content/publish/${id}`, {
        method: "PATCH",
      });

      if (!res.ok) {
        alert("Failed to publish lecture");
        return;
      }

      // reload to reflect status change
      location.reload();
    } catch (err) {
      console.error(err);
      alert("Error publishing lecture");
    }
  }

  async function unpublishLecture(id) {
    try {
      const res = await fetch(`/api/course-content/unpublish/${id}`, {
        method: "PATCH",
      });

      if (!res.ok) {
        alert("Failed to unpublish lecture");
        return;
      }

      location.reload();
    } catch (err) {
      console.error(err);
      alert("Error unpublishing lecture");
    }
  }

    function toggleLectureType(type) {
      document.getElementById('videoField').classList.add('hidden');
      document.getElementById('liveField').classList.add('hidden');

      if (type === 'video') {
        document.getElementById('videoField').classList.remove('hidden');
      }

      if (type === 'live') {
        document.getElementById('liveField').classList.remove('hidden');
      }
    }
  </script>

</body>
</html>
