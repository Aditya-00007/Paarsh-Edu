<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Placement Management - Paarsh E-Learning</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-[#f4f6f9]">

    <!-- HEADER -->
    <%- include('../partials/header.ejs') %>

        <div class="flex">

            <!-- SIDEBAR -->
            <%- include('../partials/sidebar.ejs') %>

                <!-- MAIN CONTENT -->
                <main class="flex-1 p-6 space-y-6" id="placementManagementPage">

                    <!-- PAGE TITLE -->
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold">Placement Management</h2>
                        <button onclick="openAddCompanyModal()"
                            class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                            + Add Company
                        </button>
                    </div>

                    <!-- PLACEMENT STATS -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <p class="text-sm text-gray-500">Eligible Students</p>
                            <h3 class="text-2xl font-bold">
                                <%= stats.totalEligible %>
                            </h3>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <p class="text-sm text-gray-500">Placed</p>
                            <h3 class="text-2xl font-bold text-green-600">
                                <%= stats.placedCount %>
                            </h3>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <p class="text-sm text-gray-500">In Process</p>
                            <h3 class="text-2xl font-bold text-blue-600">
                                <%= stats.inProcessCount %>
                            </h3>
                        </div>

                        <div class="bg-white p-4 rounded-xl shadow-sm">
                            <p class="text-sm text-gray-500">Closed</p>
                            <h3 class="text-2xl font-bold text-red-600">
                                <%= stats.closedCount %>
                            </h3>
                        </div>
                    </div>

                    <!-- PLACEMENT TABLE -->
                    <div id="placementTableSection">
                        <div class="bg-white rounded-xl shadow-sm p-4 overflow-x-auto">
                            <div class="flex justify-between items-center mb-3">
                                <h5 class="font-semibold text-lg">Placement Candidates</h5>

                                <!-- Future Filters -->
                                <select class="border rounded px-2 py-1 text-sm">
                                    <option>All Status</option>
                                    <option>In Process</option>
                                    <option>Placed</option>
                                    <option>Closed</option>
                                </select>
                            </div>

                            <table class="w-full text-sm">
                                <thead class="border-b text-gray-600">
                                    <tr>
                                        <th class="text-left py-2">Student</th>
                                        <th class="text-left py-2">Course</th>
                                        <th class="text-left py-2">Calls</th>
                                        <th class="text-left py-2">Status</th>
                                        <th class="text-left py-2">Action</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <% placements.forEach(p=> { %>
                                        <tr class="border-b">
                                            <td class="py-3">
                                                <%= p.student?.name || "N/A" %>
                                            </td>
                                            <td class="py-3">
                                                <%= p.course?.title || "N/A" %>
                                            </td>
                                            <td class="py-3">
                                                <%= p.callsUsed %> / <%= p.totalCallsAllowed %>
                                            </td>
                                            <td class="py-3">
                                                <% if (p.currentStatus==="placed" ) { %>
                                                    <span
                                                        class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-semibold">
                                                        Placed
                                                    </span>

                                                    <% } else if (p.currentStatus==="closed" ) { %>
                                                        <span
                                                            class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold">
                                                            Closed
                                                        </span>

                                                        <% } else if (p.interviewCount> 0) { %>
                                                            <span
                                                                class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-semibold">
                                                                In Process
                                                            </span>

                                                            <% } else { %>
                                                                <span
                                                                    class="px-3 py-1 rounded-full bg-gray-100 text-gray-700 text-xs font-semibold">
                                                                    Not Started
                                                                </span>
                                                                <% } %>
                                            </td>


                                            <td class="py-3">
                                                <% if (p.currentStatus !=="placed" && p.callsUsed < p.totalCallsAllowed)
                                                    { %>
                                                    <button
                                                        class="text-xs px-3 py-1 border border-blue-600 rounded text-blue-600 hover:bg-blue-600 hover:text-white transition"
                                                        onclick="openInterviewModal(
        '<%= p.enrollmentId %>',
        '<%= p.student._id %>'
      )">
                                                        Assign Interview
                                                    </button>
                                                    <% } %>

                                                        <button
                                                            class="text-xs px-3 py-1 border border-gray-600 rounded text-gray-600 hover:bg-gray-600 hover:text-white transition"
                                                            onclick="showInterviewTable('<%= p.enrollmentId %>')">
                                                            View Interviews
                                                        </button>
                                            </td>


                                        </tr>
                                        <% }) %>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- // interview table -->
                    <div id="interviewTableSection" class="hidden">
                        <div class="bg-white rounded-xl shadow-sm p-4 overflow-x-auto mt-6">
                            <div class="flex justify-between items-center mb-3">
                                <h5 class="font-semibold text-lg">Interviews</h5>

                                <select class="border rounded px-2 py-1 text-sm">
                                    <option>All Status</option>
                                    <option>Scheduled</option>
                                    <option>Selected</option>
                                    <option>Rejected</option>
                                </select>
                                <button onclick="backToPlacements()" class="mb-3 text-sm text-blue-600 hover:underline">
                                    ‚Üê Back to Placement List
                                </button>

                            </div>

                            <table class="w-full text-sm">
                                <thead class="border-b text-gray-600">
                                    <tr>
                                        <th class="text-left py-2">Student</th>
                                        <th class="text-left py-2">Company</th>
                                        <th class="text-left py-2">Interview Date</th>
                                        <th class="text-left py-2">Status</th>
                                        <th class="text-left py-2">Action</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <tr id="noInterviewRow" class="hidden">
  <td colspan="5" class="text-center py-6 text-gray-400">
    No interviews for this enrollment
  </td>
</tr>

                                    <% interviews.forEach(i=> { %>

                                        <tr class="border-b interview-row"
                                            data-enrollment="<%= i.enrollment ? i.enrollment.toString() : '' %>">

                                            <td class="py-3">
                                                <%= i.student?.name || "N/A" %>
                                            </td>

                                            <td class="py-3">
                                                <%= i.company?.name || "N/A" %>
                                            </td>

                                            <td class="py-3">
                                                <%= i.scheduledAt ? new Date(i.scheduledAt).toLocaleString("en-IN", {
                                                    dateStyle: "medium" , timeStyle: "short" }) : "N/A" %>
                                            </td>

                                            <td class="py-3">
                                                <% if (i.status==="selected" ) { %>
                                                    <span
                                                        class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-semibold">
                                                        Selected
                                                    </span>
                                                    <% } else if (i.status==="scheduled" ) { %>
                                                        <span
                                                            class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-semibold">
                                                            Scheduled
                                                        </span>
                                                        <% } else { %>
                                                            <span
                                                                class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold">
                                                                Rejected
                                                            </span>
                                                            <% } %>
                                            </td>

                                            <td class="py-3">
                                                <% if (i.status==="scheduled" ) { %>
                                                    <button class="text-xs px-3 py-1 border border-green-600 rounded
                         text-green-600 hover:bg-green-600 hover:text-white transition">
                                                        Mark Selected
                                                    </button>
                                                    <% } else { %>
                                                        <span class="text-xs text-gray-400">No Action</span>
                                                        <% } %>
                                            </td>

                                        </tr>

                                        <% }) %>
                                </tbody>

                            </table>
                        </div>
                    </div>


                </main>
        </div>

        <%- include('../partials/placement-Actions.ejs') %>

            <script>
  // ---------------- COMPANY MODAL ----------------
  function openAddCompanyModal() {
    document.getElementById("addCompanyModal").classList.remove("hidden");
    document.body.classList.add("overflow-hidden");
  }

  function closeAddCompanyModal() {
    document.getElementById("addCompanyModal").classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
  }

  // ---------------- INTERVIEW MODAL ----------------
  function openInterviewModal(enrollmentId, studentId) {
    if (!enrollmentId) {
      alert("Enrollment ID missing. Cannot assign interview.");
      return;
    }

    document.getElementById("interviewEnrollmentId").value = enrollmentId;
    document.getElementById("interviewStudentId").value = studentId;
    document.getElementById("assignInterviewModal").classList.remove("hidden");
  }

  function closeInterviewModal() {
    document.getElementById("assignInterviewModal").classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
  }

  // ---------------- TABLE SWITCHING ----------------
  let activeEnrollmentId = null;

  function showInterviewTable(enrollmentId) {
    activeEnrollmentId = enrollmentId;

    // switch views
    document.getElementById("placementTableSection").classList.add("hidden");
    document.getElementById("interviewTableSection").classList.remove("hidden");

    let hasAny = false;

    document.querySelectorAll(".interview-row").forEach(row => {
      if (row.dataset.enrollment === enrollmentId) {
        row.style.display = "";
        hasAny = true;
      } else {
        row.style.display = "none";
      }
    });

    document
      .getElementById("noInterviewRow")
      .classList.toggle("hidden", hasAny);
  }

  function backToPlacements() {
    activeEnrollmentId = null;

    document.getElementById("interviewTableSection").classList.add("hidden");
    document.getElementById("placementTableSection").classList.remove("hidden");

    document.querySelectorAll(".interview-row").forEach(row => {
      row.style.display = "";
    });
  }
</script>

</body>

</html>